---
title: "eicCluster report"
date: "`r Sys.Date()`"
header-includes:
     - \usepackage{longtable}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(dpi=300, cache=FALSE,echo=F,warning=F,message=F,autodep=T,fig.height=7,fig.width=7,dpi=300)
library(knitr)
library(xtable)
```


```{r pict1}

for(i in as.numeric(input$report_choices)){
  i = reported$l[[i]]
  layout(cbind(c(1,1,2,2),c(3:6)))
  ## first the 2 scoreplot top no zoom, bottom zoom
  par(mar=c(3,3,2,0.5),mgp=c(1.5,0.5,0),yaxs="r", xaxs="r")
  for(j in c(T,F)){ 
    Int <- apply(data.VarSel$eic,1,sum)
    rbPal <- colorRampPalette(c('blue','red'))
    Col <- rbPal(10)[as.numeric(cut(log10(Int),breaks = 10))]

    if(j){
      plot(data.VarSel$model,type="n",xlab="",ylab="")
      text(data.VarSel$model,labels=rownames(data.VarSel$eic),col=Col,cex = 0.5)
    }else{
      plot(data.VarSel$model,type="n",xlim = i$x, ylim = i$y,xlab="",ylab="")
      text(data.VarSel$model,labels=rownames(data.VarSel$eic),col=Col)
    }
    title(main=data.VarSel$algo,xlab = "dimension 1",ylab="dimension 2")
    ## add the scoreplot_cross if applicable
    # if(!is.null(input$scroreplot_cross)){
    #   text(x=data.VarSel$model[input$scroreplot_cross,1],y=data.VarSel$model[input$scroreplot_cross,2],labels="X",col="darkgreen",cex=3)
    # }
    ## add the contour
    my.cols <- rev(RColorBrewer::brewer.pal(11, "RdYlBu"))
    z <- MASS::kde2d(data.VarSel$model[,1], data.VarSel$model[,2], n=50)
    contour(z, drawlabels=FALSE, nlevels=11, col=my.cols, add=TRUE)

    ## add the selected zone if aplicable
    if(j){
      symbols(x=mean(i$x),y=mean(i$y),
              rectangles = rbind(c(i$x[2]-i$x[1],i$y[2]-i$y[1])),
              add=T,inches = F,fg="darkgreen",lwd=2)
    }
  }
  
  ## TIC and EIC
    leg = c("tic")
    col = c("black")
    
    data = data.ls()
    x=range.time$x[1]:range.time$x[2]
    par(mar=c(3, 3, 2, 2))
    plot(x=x,y=apply(data.VarSel$eic,2,sum),type="l",xlab="time (min)",ylab="TIC intensity (cps)",xaxt="n")

    axis(side = 1,at=seq(range.time$x[1],range.time$x[2],length.out = 10),
         labels = round(seq(getTime(data,x[1]*length(cond())),getTime(data,x[length(x)]*length(cond())),length.out = 10),2))
    par(new=T)
    if(length(i$index)>1){
      truc <- apply(data.VarSel$eic[i$index,],2,sum)
    }else{
      truc <- data.VarSel$eic[i$index,]
    }
    plot(x=x,y=truc,type="l",col="red",xaxt="n",yaxt="n",ylab="",xlab="")
    axis(side = 4,at = seq(0,max(truc),length.out = 10),labels=format(seq(0,max(truc),length.out = 10),scientific = T,digits = 2),col = 2,col.ticks = 2)
    # mtext(side=4,text="EIC intensity (cps)")
    leg = c(leg,"eicCluster")
    col = c(col,"red")

    legend("topright",legend = leg,lty=1,col=col,cex = 0.7)
    
    index.max = x[which.max(truc)]
    
  ## Ion cluster
    par(yaxs="i", xaxs="i",mar=c(3, 3, 2, 0.5),mgp=c(1.5,0.5,0))
    df <- data.frame(x = as.numeric(rownames(data.VarSel$eic[i$index,])),y = apply(data.VarSel$eic[i$index,],1,sum))
      df <- df[order(df[,2],decreasing = T),]
      plot(df,type="h",xlim=range.mz_full(),ylab="intensity",xlab="mz",ylim=c(0,df[1,2]*1.2),main="Selected ion cluster")
      text(x=df[1:10,1],y=df[1:10,2],labels=df[1:10,1],pos=3)
      
  ## Averaged full scan
    df <- data.frame(x = as.numeric(rownames(data.VarSel$eic)),y = apply(data.VarSel$eic,1,sum))
    df <- df[order(df[,2],decreasing = T),]
    plot(df,type="h",xlim=range.mz_full(),ylab="intensity",xlab="mz",ylim=c(0,df[1,2]*1.2),main="Averaged full scan")
    text(x=df[1:10,1],y=df[1:10,2],labels=df[1:10,1],pos=3)
    
  ## full scan at maximum
    data = data.ls()
    ind = seq(as.numeric(input$mode),length(data),by=length(cond()))[index.max] ## truc refer to the TIC EIC spectrum defined before
    df = data.frame(x=data[[ind]]$spectrum$mass,y=data[[ind]]$spectrum$intensity)
    df <- df[order(df[,2],decreasing = T),]
    plot(df,type="h",xlim=range.mz_full(),ylab="intensity",xlab="mz",ylim=c(0,df[1,2]*1.2),main="Full scan at cluster EIC maximum")
    text(x=df[1:10,1],y=df[1:10,2],labels=round(df[1:10,1],4),pos=3)
  
}
# par(mfrow=c(1,3))

```
  
